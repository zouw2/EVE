---
title: "Evaluate testing data (regression) - Lasso"
author: "Andrew Chang"
date: '`r Sys.Date()`'
output:
  pdf_document:
    toc: yes
    toc_depth: '3'
---

Labels: os_time


```{r}
## user input
project_home <- "~/EVE/tests"
project_name <- "lasso_regression_outCV_test"
```

## 0. Load Data
```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(broom)
library(caret)
library(pROC)
source("~/EVE/eve/reports/utils/PerformanceUtils.R")
load(paste0(project_home,"/log/", project_name, "/metainfo.Rdata"))

if(grepl("\\.r$|\\.R$", runSpec$engine)){
  df.preval <- getResults(project_home, project_name, "rdata", objName = "df_pred")
  df.vimp   <- getResults(project_home, project_name, "rdata", objName = "df_vimp")
} else {
  df.preval <- getResults(project_home, project_name, "prevalidation")
  df.vimp   <- getResults(project_home, project_name, "vimp")
}

## get original data info
df.orig <- read_csv(paste(project_home, runSpec$training_data, sep="/"))

tot.sample <- dim(df.orig)[1]
tot.feature <- max(df.preval$size)
num.cv <- length(unique(df.preval$cv))
num.seed <- length(unique(df.preval$seed))

cat(tot.sample, "of samples were used \n")
cat(tot.feature, "of full features\n")
cat(num.seed, "runs, each run contains", num.cv, "CVs.\n")
cat(runSpec$label_name, ":\n")
summary(df.orig[[runSpec$label_name]])
```


## 1. Scores

`average = T`: scores are based on pre-validation (combine predictions from all CVs per job and then calculate a single score per job). 

`average = F`: report all the scores from each CV across entire jobs. 

```{r, fig.width=6, fig.height=6, echo=FALSE, message=FALSE, warning=FALSE}
plt <- plotRMSE(df.preval, label_name = runSpec$label_name, average = T)
plt$overall
```

### correlation

```{r, echo=FALSE}
df.in <- df.preval %>% filter(seed == 1001)
lb_name <- as.name(runSpec$label_name)
ggplot(data = df.in, 
       aes_string(x="pred", y = lb_name)) + 
  geom_point() #+
  #scale_x_continuous(limits = c(-2.25, -1.25)) +
  #scale_y_continuous(limits = c(-2.25, -1.25))
```

```{r, echo=FALSE}
lb_name <- as.name(runSpec$label_name)
df.preval %>% 
  group_by(seed) %>% 
  summarise(corr = cor(!!lb_name, pred)) %>% 
  summarise(cor.avg = mean(corr),
            cor.sdt = sd(corr))
```

## 2. Important Features

For Lasso, we calculate how many times a given features is being used in all the runs.

```{r, message=FALSE, echo=FALSE, warning=FALSE}
main <- paste('distribution across', length(unique(df.vimp$seed)), 'seed x', length(unique(df.vimp$cv)),'CV')
xlab <- paste('# of times a feature is selected by lasso (alpha=', runSpec$alpha,')')
hist(table(df.vimp$feature), main = main , xlab = xlab)
```

```{r, fig.height=6, echo=FALSE}
par(mar=c(5,20,4,2))
barplot(tail(sort(table(df.vimp$feature)), 20), 
        horiz =T, las=2, main='most used features')
```






